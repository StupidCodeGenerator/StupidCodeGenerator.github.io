---
title: "New Bwapi"
layout: post
description: ""
robots: none
---

采用分布式架构，不再做整体AI，而是给每一个单位做一个AI，加以一个简单的领导AI。领导AI将当前的策略广播给所有单位，然后每一个单位根据获得的策略进行工作。
当前只做默认策略。目的是用默认策略做到整个游戏能够跑起来。

使用的种族当前先确定为人族。因为人族的组织关系比较明显。虫族和神族都有类似进化和合体的过程。另外就是人族的前期机枪兵就可以做很多事，所以人族的前期策略其实还要简单一些。

首先让我们先把这个分布式的架构搭起来。

做一个UnitBrain类，这个类专门用来对应一个unit。
做一个UnitBrainManager，用来监听事件，插入删除UnitBrain，以及广播决策等。

另外需要一个EnemyManager,用来识别出现的敌人,进行分析. 包括出现过的,以及当前能看见的.

另外每个单元都需要知道别的单元正在做什么, 所以需要有一个公告板. 因为AI是单线程,所以有严格先后顺序.

貌似事件驱动和Update有延迟,那么实在不行就抵消掉这个延迟.Create以后, 等一会儿再开始判定死亡. 可以设定一个一秒的延迟.

感觉, 事件和Update应该是两个线程
也是, 否则用户的操作会影响刷新的流畅性,所以肯定是两个线程. 不过那也不应冲突? 再研究研究

OK, 不管那么多, 反正用Create和Destory定义的单位表还是挺稳的,这个输出也留着用来进行比对. 下一步是创建Brain

矿和气都是Unit, 所以他们的管理其实都是在Unit里面的

接下来造人口, 造人口最大的问题就是需要对地图进行识别和规划. 
第一个问题就是对地图块进行识别. 这个估计要翻文档.

Broodwar 里面每一个地图块貌似被称作一个Region. 于是乎, 我可以用 CommandCenter作为中心, 去分析在某一个范围内的所有图块.
在一阶逻辑里面, 这个接口放到CommandCenter里面进行,因为除非需要野建筑, 否则大多数情况下, 建筑物都要围绕着CommandCenter进行建造. 
考虑到普适性, 让建筑物依托地形建造, 应该算是二阶逻辑. 

在一阶逻辑里面, 建筑物应当均匀的围绕着CommandCenter, 并且不能挡在SCV的路线上. CommandCenter周围2个Region内为禁止建造区
需要以CommandCenter为中心, 连接到一定范围内的所有的水晶, 画出一个矿区. 矿区内为禁止建造区.

每一个CommandCenter被创建的时候, 要先对周围一定范围的地图块进行扫描, 记录. 然后根据到CommandCenter的距离进行排序.
然后去掉不可创建区, 剩下的则为建造点集合. 这些"建造点"会被存储在CommandCenter的Brain里面, 然后对外提供个接口.

如果简单的判定, 可以把"矿区"视为方的, 也就是包含所有水晶, 气矿, 以及CommandCenter的最小矩形.